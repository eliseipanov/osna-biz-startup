<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">FARM CONNECT</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .gold-text {
            color: #D4AF37;
        }
        .gold-bg {
            background-color: #D4AF37;
        }
        .gold-border {
            border-color: #D4AF37;
        }
        .dark-bg {
            background-color: #121212;
        }
        .silver-text {
            color: #E0E0E0;
        }
    </style>
</head>
<body class="dark-bg min-h-screen">
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Discovery View -->
        <div id="discovery-view">
            <!-- Hero Header -->
            <header class="relative mb-8">
                <div class="w-full h-64 md:h-80 lg:h-96 overflow-hidden">
                    <img src="/static/uploads/hero.jpg" alt="Farm Connect Hero" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                        <div class="text-center">
                            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold gold-text mb-4" id="ui-title">FARM CONNECT</h1>
                            <p class="text-lg md:text-xl silver-text" id="ui-subtitle">Premium Farm Products</p>
                        </div>
                    </div>
                </div>
            </header>
            <!-- Regions Section -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold mb-4 gold-text" id="ui-select-region">Select Region</h2>
                <div id="regions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Regions will be loaded here -->
                </div>
            </section>

            <!-- Farm Types Section -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold mb-4 gold-text" id="ui-farm-types">Farm Types</h2>
                <div id="farm-types-list" class="flex flex-wrap gap-3">
                    <!-- Farm type buttons will be generated dynamically -->
                </div>
            </section>

            <!-- Farms Section -->
            <section id="farms-section">
                <h2 class="text-xl font-semibold mb-4 gold-text" id="ui-available-farms">Available Farms</h2>
                <div id="farms-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Farms will be loaded here -->
                </div>
            </section>
        </div>

        <!-- Shop View -->
        <div id="shop-view" class="hidden">
            <!-- Farm Hero Image -->
            <div id="farm-hero" class="w-full h-48 md:h-64 mb-6 bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center">
                <!-- Farm image will be displayed here -->
            </div>

            <!-- Back Button -->
            <div class="mb-4">
                <button id="back-to-farms" class="px-4 py-2 bg-transparent border-2 border-gold text-gold hover:bg-gold hover:text-black font-medium rounded-lg transition-colors">
                    ‚¨ÖÔ∏è <span id="ui-btn-back"></span>
                </button>
            </div>

            <!-- Farm Info -->
            <div class="text-center mb-6">
                <h2 class="text-xl font-semibold gold-text" id="farm-name-title">Farm Products</h2>
                <p class="text-sm text-silver" id="farm-description">Farm description</p>
            </div>

            <!-- Category Grid -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3 gold-text"><span id="ui-label-categories"></span></h3>
                <div id="categories-grid" class="grid grid-cols-2 gap-4">
                    <!-- Category tiles will be rendered here -->
                </div>
            </div>

            <!-- Products Feed -->
            <div id="products-list" class="space-y-4">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Cart View -->
        <div id="cart-view" class="hidden">
            <!-- Cart Header -->
            <div class="mb-6">
                <button id="back-to-farms" class="px-4 py-2 bg-transparent border-2 border-gold text-gold hover:bg-gold hover:text-black font-medium rounded-lg transition-colors">
                    ‚¨ÖÔ∏è <span id="ui-btn-back"></span>
                </button>
            </div>

            <!-- Cart Items -->
            <div id="cart-items" class="space-y-4 mb-6">
                <!-- Cart items will be rendered here -->
            </div>

            <!-- Cart Total & Checkout -->
            <div id="cart-summary" class="bg-gray-800 rounded-lg p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-semibold gold-text">Total:</span>
                    <span id="cart-grand-total" class="text-xl font-bold gold-text">0.00 ‚Ç¨</span>
                </div>
                <button id="checkout-btn" class="w-full px-6 py-3 bg-gold text-black font-bold rounded-lg hover:bg-opacity-90 transition-colors">
                    Checkout
                </button>
            </div>

            <!-- Empty Cart Message -->
            <div id="empty-cart" class="text-center py-16">
                <div class="text-6xl mb-4">üõí</div>
                <h2 class="text-2xl font-bold gold-text mb-2">Your Cart is Empty</h2>
                <p class="text-silver">Add some delicious products to get started!</p>
            </div>
        </div>
    </main>

    <!-- Sticky Cart Footer -->
    <div id="sticky-cart" class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t-4 border-gold text-gold p-4 hidden z-50 cursor-pointer" onclick="showCartView()">
        <div class="max-w-7xl mx-auto flex items-center justify-center">
            <div class="flex items-center space-x-6 text-xl">
                <span>üõí</span>
                <span id="cart-count" class="font-medium">0 items</span>
                <span id="cart-total" class="font-bold">0.00 ‚Ç¨</span>
                <span>View Cart ‚ûî</span>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top" class="fixed bottom-24 right-4 w-16 h-16 bg-gold text-black rounded-full shadow-lg opacity-0 transition-opacity duration-300 z-40 hidden text-2xl">
        ‚¨ÜÔ∏è
    </button>

    <!-- JavaScript -->
    <script>
        let selectedRegion = null;
        let selectedFarmType = null;
        let translations = {};
        let userLanguage = 'uk';
        let currentView = 'farms'; // 'farms' or 'products'
        let selectedFarm = null;
        let selectedCategory = null; // null means 'All'
        let categories = [];
        let cartState = {}; // { productId: { qty, price, name } }
        let productsData = []; // Store product data for cart calculations

        // Get language from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        userLanguage = urlParams.get('lang') || 'uk';
        const startMode = urlParams.get('start_mode');

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }

            // Load cart state from localStorage
            loadCartState();

            // Handle routing
            if (startMode === 'cart') {
                showCartView();
            } else {
                loadTranslations();
            }

            // Scroll event for scroll-to-top button
            window.addEventListener('scroll', function() {
                const scrollButton = document.getElementById('scroll-to-top');
                if (window.scrollY > 300) {
                    scrollButton.classList.remove('hidden');
                    scrollButton.classList.remove('opacity-0');
                    scrollButton.classList.add('opacity-100');
                } else {
                    scrollButton.classList.add('opacity-0');
                    setTimeout(() => scrollButton.classList.add('hidden'), 300);
                }
            });
        });

        // Event listeners
        document.addEventListener('click', function(e) {
            // Region selection
            if (e.target.classList.contains('region-btn') || e.target.closest('.region-btn')) {
                const btn = e.target.closest('.region-btn');
                // Remove active class from all region buttons
                document.querySelectorAll('.region-btn').forEach(b => {
                    b.classList.remove('gold-bg', 'text-black');
                    b.classList.add('bg-gray-800', 'text-silver');
                });

                // Add active class to clicked button
                btn.classList.remove('bg-gray-800', 'text-silver');
                btn.classList.add('gold-bg', 'text-black');

                selectedRegion = btn.dataset.regionId;
                loadFarms();
            }

            // Farm type selection
            if (e.target.classList.contains('farm-type-btn') || e.target.closest('.farm-type-btn')) {
                const btn = e.target.closest('.farm-type-btn');
                // Remove active class from all farm type buttons
                document.querySelectorAll('.farm-type-btn').forEach(b => {
                    b.classList.remove('gold-bg', 'text-black');
                    b.classList.add('bg-gray-800', 'text-silver');
                });

                // Add active class to clicked button
                btn.classList.remove('bg-gray-800', 'text-silver');
                btn.classList.add('gold-bg', 'text-black');

                selectedFarmType = btn.dataset.type;
                loadFarms();
            }

            // Enter shop button
            if (e.target.classList.contains('enter-shop-btn') || e.target.closest('.enter-shop-btn')) {
                const btn = e.target.closest('.enter-shop-btn');
                const farmId = btn.dataset.farmId;
                const farmName = btn.dataset.farmName;
                const farmDescription = btn.dataset.farmDescription;
                const farmImage = btn.dataset.farmImage;
                showProducts(farmId, farmName, farmDescription, farmImage);
            }

            // Back to farms button
            if (e.target.id === 'back-to-farms') {
                showFarms();
            }

            // Category selection (clicking a grid tile)
            if (e.target.classList.contains('category-tile') || e.target.closest('.category-tile')) {
                const tile = e.target.closest('.category-tile');
                const categoryId = tile.dataset.categoryId;

                // Remove active class from all tiles
                document.querySelectorAll('.category-tile').forEach(t => {
                    t.classList.remove('ring-2', 'ring-gold');
                });

                // Add active class to clicked tile
                tile.classList.add('ring-2', 'ring-gold');

                selectedCategory = categoryId;
                loadProducts(selectedFarm.id);
            }

            // Quantity controls
            if (e.target.classList.contains('qty-btn')) {
                const btn = e.target;
                const productId = parseInt(btn.dataset.productId);
                const action = btn.dataset.action;

                // Find product data
                const product = productsData.find(p => p.id == productId);
                if (!product) return;

                if (action === 'increase') {
                    addToCart(productId, 1, product);
                } else if (action === 'decrease') {
                    addToCart(productId, -1, product);
                }
            }


            // Scroll to top button
            if (e.target.id === 'scroll-to-top') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Cart quantity controls
            if (e.target.classList.contains('cart-qty-btn')) {
                const btn = e.target;
                const productId = parseInt(btn.dataset.productId);
                const action = btn.dataset.action;

                if (action === 'increase') {
                    addToCart(productId, 1);
                    renderCartItems(); // Re-render cart after quantity change
                } else if (action === 'decrease') {
                    addToCart(productId, -1);
                    renderCartItems(); // Re-render cart after quantity change
                }
            }

            // Checkout button
            if (e.target.id === 'checkout-btn') {
                handleCheckout();
            }
        });

        function generateFarmTypeButtons() {
            const farmTypes = [
                { type: 'meat', defaultText: 'Meat' },
                { type: 'vegetables', defaultText: 'Vegetables' },
                { type: 'fish', defaultText: 'Fish' },
                { type: 'poultry', defaultText: 'Poultry' }
            ];

            const farmTypesList = document.getElementById('farm-types-list');
            farmTypesList.innerHTML = '';

            farmTypes.forEach(farmType => {
                const button = document.createElement('button');
                button.className = 'farm-type-btn px-4 py-2 bg-gray-800 hover:gold-bg hover:text-black text-silver rounded-lg transition-colors';
                button.dataset.type = farmType.type;
                button.id = `btn-${farmType.type}`;

                // Labels come 100% from database (no hardcoded emojis)
                const translationKey = `type_${farmType.type}`;
                button.innerHTML = translations[translationKey] || farmType.defaultText;

                farmTypesList.appendChild(button);
            });
        }

        async function loadTranslations() {
            try {
                const response = await fetch(`/api/ui/translations?lang=${userLanguage}`);
                translations = await response.json();

                // Update page title
                document.getElementById('page-title').textContent = translations.webapp_title || 'FARM CONNECT';

                // Update hero section
                document.getElementById('ui-title').textContent = translations.webapp_title || 'FARM CONNECT';
                document.getElementById('ui-subtitle').textContent = translations.webapp_subtitle || 'Premium Farm Products';

                // Update section headers
                document.getElementById('ui-select-region').textContent = translations.webapp_select_region || 'Select Region';
                document.getElementById('ui-farm-types').textContent = translations.webapp_farm_types || 'Farm Types';
                document.getElementById('ui-available-farms').textContent = translations.webapp_available_farms || 'Available Farms';

                // Generate farm type buttons dynamically
                generateFarmTypeButtons();

                // Populate UI text elements
                document.getElementById('ui-btn-back').innerText = translations['webapp_back_to_farms'] || 'Back to Farms';
                document.getElementById('ui-label-categories').innerText = translations['webapp_categories'] || 'Categories';

                // Now load other data
                loadRegions();
                loadFarms();
            } catch (error) {
                console.error('Error loading translations:', error);
                // Fallback - load data anyway
                loadRegions();
                loadFarms();
            }
        }

        async function loadRegions() {
            try {
                const response = await fetch('/api/catalog/regions');
                const regions = await response.json();

                const regionsList = document.getElementById('regions-list');
                regionsList.innerHTML = '';

                regions.forEach(region => {
                    const regionCard = document.createElement('div');
                    regionCard.className = 'region-btn p-4 bg-gray-800 hover:gold-bg hover:text-black text-silver rounded-lg cursor-pointer transition-colors';
                    regionCard.dataset.regionId = region.id;
                    regionCard.innerHTML = `
                        <h3 class="font-semibold">${userLanguage === 'de' ? region.name_de : region.name}</h3>
                    `;
                    regionsList.appendChild(regionCard);
                });
            } catch (error) {
                console.error('Error loading regions:', error);
            }
        }

        async function loadFarms() {
            try {
                let url = '/api/catalog/farms';
                const params = new URLSearchParams();

                if (selectedRegion) {
                    params.append('region_id', selectedRegion);
                }
                if (selectedFarmType) {
                    params.append('farm_type', selectedFarmType);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const farms = await response.json();

                const farmsList = document.getElementById('farms-list');
                farmsList.innerHTML = '';

                if (farms.length === 0) {
                    farmsList.innerHTML = `<p class="text-silver col-span-full text-center py-8">${translations.no_farms_found || 'No farms found for the selected criteria.'}</p>`;
                    return;
                }

                farms.forEach(farm => {
                    const description = userLanguage === 'de' ? (farm.description_de || farm.description_uk) : (farm.description_uk || farm.description_de);
                    const imageUrl = farm.image_path ? `/static/uploads/${farm.image_path}` : null;

                    const farmCard = document.createElement('div');
                    farmCard.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg';
                    farmCard.innerHTML = `
                        <div class="h-48 bg-gray-700 flex items-center justify-center">
                            ${imageUrl ?
                                `<img src="${imageUrl}" alt="${farm.name}" class="w-full h-full object-cover">` :
                                `<div class="text-6xl gold-text font-bold">${farm.name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div class="p-6">
                            <h3 class="text-lg font-semibold mb-2 gold-text">${farm.name}</h3>
                            <p class="text-sm text-silver mb-3">${description || translations.no_description || 'No description available'}</p>
                            <div class="flex items-center justify-between text-sm mb-4">
                                <span class="text-silver">${farm.region_name || farm.location || translations.location_not_specified || 'Location not specified'}</span>
                                <span class="gold-text font-medium">${translations[`type_${farm.farm_type}`] || farm.farm_type || translations.type_not_specified || 'Type not specified'}</span>
                            </div>
                            <button class="enter-shop-btn w-full px-4 py-2 bg-transparent border-2 border-gold text-gold hover:bg-gold hover:text-black font-medium rounded-lg transition-colors" data-farm-id="${farm.id}" data-farm-name="${farm.name}" data-farm-description="${description}" data-farm-image="${imageUrl || ''}">
                                üõí ${translations.webapp_enter_shop || 'Enter Shop'}
                            </button>
                        </div>
                    `;
                    farmsList.appendChild(farmCard);
                });
            } catch (error) {
                console.error('Error loading farms:', error);
            }
        }

        function showProducts(farmId, farmName, farmDescription, farmImage) {
            currentView = 'products';
            selectedFarm = { id: farmId, name: farmName, description: farmDescription, image: farmImage };
            selectedCategory = null; // Reset category filter

            // Hide discovery view, show shop view
            document.getElementById('discovery-view').classList.add('hidden');
            document.getElementById('shop-view').classList.remove('hidden');

            // Update farm hero image
            const farmHero = document.getElementById('farm-hero');
            if (farmImage) {
                farmHero.innerHTML = `<img src="${farmImage}" alt="${farmName}" class="w-full h-full object-cover">`;
            } else {
                farmHero.innerHTML = `<div class="text-4xl gold-text font-bold">${farmName.charAt(0).toUpperCase()}</div>`;
            }

            // Update title and description
            document.getElementById('farm-name-title').textContent = farmName;
            document.getElementById('farm-description').textContent = farmDescription || '';

            // Load categories and products
            loadCategories(farmId);
            loadProducts(farmId);
        }

        function showFarms() {
            currentView = 'farms';
            selectedFarm = null;

            // Hide all views, show discovery view
            document.getElementById('shop-view').classList.add('hidden');
            document.getElementById('cart-view').classList.add('hidden');
            document.getElementById('discovery-view').classList.remove('hidden');
        }

        function showCartView() {
            // Hide other views, show cart view
            document.getElementById('discovery-view').classList.add('hidden');
            document.getElementById('shop-view').classList.add('hidden');
            document.getElementById('cart-view').classList.remove('hidden');

            // Load translations for cart view
            loadTranslations();

            // Render cart items
            renderCartItems();
        }

        function renderCartItems() {
            const cartItems = document.getElementById('cart-items');
            const cartSummary = document.getElementById('cart-summary');
            const emptyCart = document.getElementById('empty-cart');

            cartItems.innerHTML = '';
            const cartEntries = Object.entries(cartState);

            if (cartEntries.length === 0) {
                cartSummary.classList.add('hidden');
                emptyCart.classList.remove('hidden');
                return;
            }

            cartSummary.classList.remove('hidden');
            emptyCart.classList.add('hidden');

            cartEntries.forEach(([productId, item]) => {
                const itemTotal = item.price * item.qty;

                const cartItem = document.createElement('div');
                cartItem.className = 'bg-gray-800 rounded-lg p-4';
                cartItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold gold-text">${item.name}</h3>
                            <p class="text-sm text-silver">${item.price.toFixed(2)} ‚Ç¨ each</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <button class="cart-qty-btn px-2 py-1 bg-gray-700 hover:bg-gray-600 text-silver rounded" data-product-id="${productId}" data-action="decrease">-</button>
                                <span class="px-3 py-1 bg-gray-700 text-silver rounded">${item.qty}</span>
                                <button class="cart-qty-btn px-2 py-1 bg-gray-700 hover:bg-gray-600 text-silver rounded" data-product-id="${productId}" data-action="increase">+</button>
                            </div>
                            <span class="font-bold gold-text">${itemTotal.toFixed(2)} ‚Ç¨</span>
                        </div>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });

            // Update grand total
            const grandTotal = getCartTotal();
            document.getElementById('cart-grand-total').textContent = `${grandTotal.toFixed(2)} ‚Ç¨`;
        }

        function handleCheckout() {
            const orderData = {
                items: Object.entries(cartState).map(([productId, item]) => ({
                    id: parseInt(productId),
                    qty: item.qty,
                    price: item.price
                })),
                total: getCartTotal()
            };

            // Send data to Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.sendData(JSON.stringify(orderData));
            }
        }

        async function loadProducts(farmId) {
            try {
                let url = `/api/catalog/products?farm_id=${farmId}`;
                if (selectedCategory) {
                    url += `&category_id=${selectedCategory}`;
                }

                const response = await fetch(url);
                const products = await response.json();

                const productsList = document.getElementById('products-list');
                productsList.innerHTML = '';

                if (products.length === 0) {
                    productsList.innerHTML = `<p class="text-silver text-center py-8">${translations.no_products_found || 'No products found for this farm.'}</p>`;
                    return;
                }

                // Store product data for cart calculations
                productsData = products;

                products.forEach(product => {
                    const name = userLanguage === 'de' ? (product.name_de || product.name) : product.name;
                    const description = userLanguage === 'de' ? (product.description_de || product.description) : product.description;
                    const imageUrl = product.image_path ? `/static/uploads/${product.image_path}` : null;
                    const currentQty = cartState[product.id] || 0;

                    const productCard = document.createElement('div');
                    productCard.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg';
                    productCard.innerHTML = `
                        <div class="w-full aspect-square bg-gray-700 flex items-center justify-center">
                            ${imageUrl ?
                                `<img src="${imageUrl}" alt="${name}" class="w-full h-full object-cover">` :
                                `<div class="text-6xl gold-text font-bold">${name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div class="p-4">
                            <h3 class="text-lg font-semibold mb-1 gold-text">${name}</h3>
                            <p class="text-sm text-silver mb-2">${description || ''}</p>
                            <div class="flex items-center justify-between">
                                <span class="gold-text font-bold">${product.price ? `${product.price.toFixed(2)} ‚Ç¨` : ''}</span>
                                <div class="flex items-center space-x-2">
                                    <button class="qty-btn px-2 py-1 bg-gray-700 hover:bg-gray-600 text-silver rounded" data-product-id="${product.id}" data-action="decrease">-</button>
                                    <span class="qty-display px-3 py-1 bg-gray-700 text-silver rounded" data-product-id="${product.id}">${currentQty}</span>
                                    <button class="qty-btn px-2 py-1 bg-gray-700 hover:bg-gray-600 text-silver rounded" data-product-id="${product.id}" data-action="increase">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                    productsList.appendChild(productCard);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadCategories(farmId) {
            try {
                const response = await fetch(`/api/catalog/categories?farm_id=${farmId}`);
                categories = await response.json();

                renderCategoriesGrid();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderCategoriesGrid() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';

            categories.forEach(category => {
                const displayName = userLanguage === 'de' ? category.name_de : category.name;
                const imageUrl = category.image_path ? `/static/uploads/${category.image_path}` : null;

                const tile = document.createElement('div');
                tile.className = 'category-tile aspect-square bg-gray-800 rounded-lg overflow-hidden shadow-lg cursor-pointer hover:ring-2 hover:ring-gold transition-all relative';
                tile.dataset.categoryId = category.id;

                tile.innerHTML = `
                    ${imageUrl ?
                        `<img src="${imageUrl}" alt="${displayName}" class="w-full h-full object-cover">` :
                        `<div class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
                            <div class="text-4xl">${getCategoryEmoji(displayName)}</div>
                        </div>`
                    }
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                        <h4 class="text-xl font-bold gold-text text-center px-2">${displayName}</h4>
                    </div>
                `;

                grid.appendChild(tile);
            });
        }

        function getCategoryEmoji(categoryName) {
            const emojiMap = {
                'Schwein': 'üê∑',
                'Rind': 'üêÆ',
                'Wurst': 'üå≠',
                'Mix': 'ü•©'
            };
            return emojiMap[categoryName] || 'üì¶';
        }

        // Cart functions
        function loadCartState() {
            const saved = localStorage.getItem('webapp_cart');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Migration: convert old format {id: qty} to new format {id: {qty, price, name}}
                cartState = {};
                Object.entries(parsed).forEach(([productId, value]) => {
                    if (typeof value === 'number') {
                        // Old format - clear it to prevent errors
                        return;
                    } else if (typeof value === 'object' && value.qty) {
                        // New format
                        cartState[productId] = value;
                    }
                });
            } else {
                cartState = {};
            }
            updateStickyFooter();
        }

        function saveCartState() {
            localStorage.setItem('webapp_cart', JSON.stringify(cartState));
            updateStickyFooter();
        }

        function addToCart(productId, quantity, product = null) {
            if (!cartState[productId]) {
                if (!product) {
                    // Try to find product in current productsData
                    product = productsData.find(p => p.id == productId);
                }
                if (!product) return; // Cannot add without product data

                cartState[productId] = {
                    qty: 0,
                    price: product.price,
                    name: userLanguage === 'de' ? (product.name_de || product.name) : product.name
                };
            }

            cartState[productId].qty += quantity;
            if (cartState[productId].qty <= 0) {
                delete cartState[productId];
            }
            saveCartState();
            updateProductQuantityDisplay(productId);
        }

        function removeFromCart(productId) {
            delete cartState[productId];
            saveCartState();
            updateProductQuantityDisplay(productId);
        }

        function getCartCount() {
            return Object.values(cartState).reduce((sum, item) => sum + item.qty, 0);
        }

        function getCartTotal() {
            return Object.values(cartState).reduce((total, item) => total + (item.price * item.qty), 0);
        }

        function updateProductQuantityDisplay(productId) {
            const qtyDisplay = document.querySelector(`.qty-display[data-product-id="${productId}"]`);
            if (qtyDisplay) {
                qtyDisplay.textContent = cartState[productId]?.qty || 0;
            }
        }

        function updateStickyFooter() {
            const footer = document.getElementById('sticky-cart');
            const count = getCartCount();
            const total = getCartTotal();

            if (count > 0) {
                document.getElementById('cart-count').textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
                document.getElementById('cart-total').textContent = `${total.toFixed(2)} ‚Ç¨`;
                footer.classList.remove('hidden');
            } else {
                footer.classList.add('hidden');
            }
        }

    </script>
</body>
</html>