This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: templates/webapp/index.html, bot/keyboards/main_menu.py, bot/handlers/start.py
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
bot/
  handlers/
    start.py
  keyboards/
    main_menu.py
templates/
  webapp/
    index.html
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="bot/keyboards/main_menu.py">
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, WebAppInfo
from sqlalchemy import select
from core.database import async_session
from core.models import Translation

async def get_main_menu_keyboard(user_language="uk"):
    """Get main menu keyboard with localized button labels from database."""
    try:
        async with async_session() as session:
            # Fetch translations for main menu buttons
            catalog_trans = await session.scalar(
                select(Translation).where(Translation.key == "catalog_button")
            )
            cart_trans = await session.scalar(
                select(Translation).where(Translation.key == "cart_button")
            )
            orders_trans = await session.scalar(
                select(Translation).where(Translation.key == "orders_button")
            )
            profile_trans = await session.scalar(
                select(Translation).where(Translation.key == "profile_button")
            )
            impressum_trans = await session.scalar(
                select(Translation).where(Translation.key == "impressum_button")
            )

            # Get localized text based on user language
            catalog_text = (catalog_trans.value_de if user_language == "de" and catalog_trans.value_de
                          else catalog_trans.value_uk if catalog_trans else "ü•© Catalog")

            cart_text = (cart_trans.value_de if user_language == "de" and cart_trans.value_de
                        else cart_trans.value_uk if cart_trans else "üõí Cart")

            orders_text = (orders_trans.value_de if user_language == "de" and orders_trans.value_de
                          else orders_trans.value_uk if orders_trans else "üìã Orders")

            profile_text = (profile_trans.value_de if user_language == "de" and profile_trans.value_de
                          else profile_trans.value_uk if profile_trans else "üë§ Profile")

            impressum_text = (impressum_trans.value_de if user_language == "de" and impressum_trans.value_de
                            else impressum_trans.value_uk if impressum_trans else "‚ÑπÔ∏è Impressum")

            keyboard = [
                [KeyboardButton(text=catalog_text, web_app=WebAppInfo(url=f"https://7568db916eec.ngrok-free.app/webapp?lang={user_language}"))],
                [KeyboardButton(text=cart_text, web_app=WebAppInfo(url=f"https://7568db916eec.ngrok-free.app/webapp?lang={user_language}&start_mode=cart")), KeyboardButton(text=orders_text)],
                [KeyboardButton(text=profile_text), KeyboardButton(text=impressum_text)]
            ]
            return ReplyKeyboardMarkup(keyboard=keyboard, resize_keyboard=True, persistent=True)
    except Exception as e:
        # Fallback to hardcoded English if database error
        keyboard = [
            [KeyboardButton(text="ü•© Catalog", web_app=WebAppInfo(url=f"https://7568db916eec.ngrok-free.app/webapp?lang={user_language}"))],
            [KeyboardButton(text="üõí Cart", web_app=WebAppInfo(url=f"https://7568db916eec.ngrok-free.app/webapp?lang={user_language}&start_mode=cart")), KeyboardButton(text="üìã Orders")],
            [KeyboardButton(text="üë§ Profile"), KeyboardButton(text="‚ÑπÔ∏è Impressum")]
        ]
        return ReplyKeyboardMarkup(keyboard=keyboard, resize_keyboard=True, persistent=True)
</file>

<file path="templates/webapp/index.html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">FARM CONNECT</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .gold-text {
            color: #D4AF37;
        }
        .gold-bg {
            background-color: #D4AF37;
        }
        .gold-border {
            border-color: #D4AF37;
        }
        .dark-bg {
            background-color: #121212;
        }
        .silver-text {
            color: #E0E0E0;
        }
    </style>
</head>
<body class="dark-bg min-h-screen">
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Discovery View -->
        <div id="discovery-view">
            <!-- Hero Header -->
            <header class="relative mb-8">
                <div class="w-full h-64 md:h-80 lg:h-96 overflow-hidden">
                    <img src="/static/uploads/hero.jpg" alt="Farm Connect Hero" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                        <div class="text-center">
                            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold gold-text mb-4" id="ui-title">FARM CONNECT</h1>
                            <p class="text-lg md:text-xl silver-text" id="ui-subtitle">Premium Farm Products</p>
                        </div>
                    </div>
                </div>
            </header>
            <!-- Regions Section -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold mb-4 gold-text" id="ui-select-region">Select Region</h2>
                <div id="regions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Regions will be loaded here -->
                </div>
            </section>

            <!-- Farm Types Section -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold mb-4 gold-text" id="ui-farm-types">Farm Types</h2>
                <div id="farm-types-list" class="flex flex-wrap gap-3">
                    <!-- Farm type buttons will be generated dynamically -->
                </div>
            </section>

            <!-- Farms Section -->
            <section id="farms-section">
                <h2 class="text-xl font-semibold mb-4 gold-text" id="ui-available-farms">Available Farms</h2>
                <div id="farms-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Farms will be loaded here -->
                </div>
            </section>
        </div>

        <!-- Shop View -->
        <div id="shop-view" class="hidden">
            <!-- Farm Hero Image -->
            <div id="farm-hero" class="w-full h-48 md:h-64 mb-6 bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center">
                <!-- Farm image will be displayed here -->
            </div>

            <!-- Back Button -->
            <div class="mb-4">
                <button id="back-to-farms" class="px-4 py-2 bg-transparent border-2 border-gold text-gold hover:bg-gold hover:text-black font-medium rounded-lg transition-colors">
                    ‚¨ÖÔ∏è <span id="ui-btn-back"></span>
                </button>
            </div>

            <!-- Farm Info -->
            <div class="text-center mb-6">
                <h2 class="text-xl font-semibold gold-text" id="farm-name-title">Farm Products</h2>
                <p class="text-sm text-silver" id="farm-description">Farm description</p>
            </div>

            <!-- Category Hero Slider -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3 gold-text"><span id="ui-label-categories"></span></h3>
                <div id="category-slider" class="relative">
                    <!-- Left Arrow -->
                    <button id="category-prev" class="absolute left-0 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 hover:bg-opacity-75 text-gold w-12 h-12 rounded-full flex items-center justify-center transition-all">
                        ‚Äπ
                    </button>

                    <!-- Active Category Card -->
                    <div id="category-display" class="mx-16 cursor-pointer">
                        <!-- Category content will be rendered here -->
                    </div>

                    <!-- Right Arrow -->
                    <button id="category-next" class="absolute right-0 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 hover:bg-opacity-75 text-gold w-12 h-12 rounded-full flex items-center justify-center transition-all">
                        ‚Ä∫
                    </button>
                </div>
            </div>

            <!-- Products Feed -->
            <div id="products-list" class="space-y-4">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Cart View -->
        <div id="cart-view" class="hidden">
            <div class="text-center py-16">
                <div class="text-6xl mb-4">üõí</div>
                <h2 class="text-2xl font-bold gold-text mb-2">Your Cart is Empty</h2>
                <p class="text-silver">Add some delicious products to get started!</p>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        let selectedRegion = null;
        let selectedFarmType = null;
        let translations = {};
        let userLanguage = 'uk';
        let currentView = 'farms'; // 'farms' or 'products'
        let selectedFarm = null;
        let selectedCategory = null; // null means 'All'
        let categories = [];
        let currentCategoryIndex = 0;

        // Get language from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        userLanguage = urlParams.get('lang') || 'uk';
        const startMode = urlParams.get('start_mode');

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }

            // Handle routing
            if (startMode === 'cart') {
                showCartView();
            } else {
                loadTranslations();
            }
        });

        // Event listeners
        document.addEventListener('click', function(e) {
            // Region selection
            if (e.target.classList.contains('region-btn') || e.target.closest('.region-btn')) {
                const btn = e.target.closest('.region-btn');
                // Remove active class from all region buttons
                document.querySelectorAll('.region-btn').forEach(b => {
                    b.classList.remove('gold-bg', 'text-black');
                    b.classList.add('bg-gray-800', 'text-silver');
                });

                // Add active class to clicked button
                btn.classList.remove('bg-gray-800', 'text-silver');
                btn.classList.add('gold-bg', 'text-black');

                selectedRegion = btn.dataset.regionId;
                loadFarms();
            }

            // Farm type selection
            if (e.target.classList.contains('farm-type-btn') || e.target.closest('.farm-type-btn')) {
                const btn = e.target.closest('.farm-type-btn');
                // Remove active class from all farm type buttons
                document.querySelectorAll('.farm-type-btn').forEach(b => {
                    b.classList.remove('gold-bg', 'text-black');
                    b.classList.add('bg-gray-800', 'text-silver');
                });

                // Add active class to clicked button
                btn.classList.remove('bg-gray-800', 'text-silver');
                btn.classList.add('gold-bg', 'text-black');

                selectedFarmType = btn.dataset.type;
                loadFarms();
            }

            // Enter shop button
            if (e.target.classList.contains('enter-shop-btn') || e.target.closest('.enter-shop-btn')) {
                const btn = e.target.closest('.enter-shop-btn');
                const farmId = btn.dataset.farmId;
                const farmName = btn.dataset.farmName;
                const farmDescription = btn.dataset.farmDescription;
                const farmImage = btn.dataset.farmImage;
                showProducts(farmId, farmName, farmDescription, farmImage);
            }

            // Back to farms button
            if (e.target.id === 'back-to-farms') {
                showFarms();
            }

            // Category slider navigation
            if (e.target.id === 'category-prev') {
                currentCategoryIndex = (currentCategoryIndex - 1 + categories.length) % categories.length;
                renderCategorySlider();
            }
            if (e.target.id === 'category-next') {
                currentCategoryIndex = (currentCategoryIndex + 1) % categories.length;
                renderCategorySlider();
            }

            // Category selection (clicking the main card)
            if (e.target.id === 'category-display' || e.target.closest('#category-display')) {
                const categoryId = categories[currentCategoryIndex].id;
                selectedCategory = categoryId === 'all' ? null : categoryId;
                loadProducts(selectedFarm.id);
            }

            // Quantity controls
            if (e.target.classList.contains('qty-btn')) {
                const btn = e.target;
                const productId = btn.dataset.productId;
                const action = btn.dataset.action;
                updateQuantity(productId, action);
            }
        });

        function generateFarmTypeButtons() {
            const farmTypes = [
                { type: 'meat', defaultText: 'Meat' },
                { type: 'vegetables', defaultText: 'Vegetables' },
                { type: 'fish', defaultText: 'Fish' },
                { type: 'poultry', defaultText: 'Poultry' }
            ];

            const farmTypesList = document.getElementById('farm-types-list');
            farmTypesList.innerHTML = '';

            farmTypes.forEach(farmType => {
                const button = document.createElement('button');
                button.className = 'farm-type-btn px-4 py-2 bg-gray-800 hover:gold-bg hover:text-black text-silver rounded-lg transition-colors';
                button.dataset.type = farmType.type;
                button.id = `btn-${farmType.type}`;

                // Labels come 100% from database (no hardcoded emojis)
                const translationKey = `type_${farmType.type}`;
                button.innerHTML = translations[translationKey] || farmType.defaultText;

                farmTypesList.appendChild(button);
            });
        }

        async function loadTranslations() {
            try {
                const response = await fetch(`/api/ui/translations?lang=${userLanguage}`);
                translations = await response.json();

                // Update page title
                document.getElementById('page-title').textContent = translations.webapp_title || 'FARM CONNECT';

                // Update hero section
                document.getElementById('ui-title').textContent = translations.webapp_title || 'FARM CONNECT';
                document.getElementById('ui-subtitle').textContent = translations.webapp_subtitle || 'Premium Farm Products';

                // Update section headers
                document.getElementById('ui-select-region').textContent = translations.webapp_select_region || 'Select Region';
                document.getElementById('ui-farm-types').textContent = translations.webapp_farm_types || 'Farm Types';
                document.getElementById('ui-available-farms').textContent = translations.webapp_available_farms || 'Available Farms';

                // Generate farm type buttons dynamically
                generateFarmTypeButtons();

                // Populate UI text elements
                document.getElementById('ui-btn-back').innerText = translations['webapp_back_to_farms'] || 'Back to Farms';
                document.getElementById('ui-label-categories').innerText = translations['webapp_categories'] || 'Categories';

                // Now load other data
                loadRegions();
                loadFarms();
            } catch (error) {
                console.error('Error loading translations:', error);
                // Fallback - load data anyway
                loadRegions();
                loadFarms();
            }
        }

        async function loadRegions() {
            try {
                const response = await fetch('/api/catalog/regions');
                const regions = await response.json();

                const regionsList = document.getElementById('regions-list');
                regionsList.innerHTML = '';

                regions.forEach(region => {
                    const regionCard = document.createElement('div');
                    regionCard.className = 'region-btn p-4 bg-gray-800 hover:gold-bg hover:text-black text-silver rounded-lg cursor-pointer transition-colors';
                    regionCard.dataset.regionId = region.id;
                    regionCard.innerHTML = `
                        <h3 class="font-semibold">${userLanguage === 'de' ? region.name_de : region.name}</h3>
                    `;
                    regionsList.appendChild(regionCard);
                });
            } catch (error) {
                console.error('Error loading regions:', error);
            }
        }

        async function loadFarms() {
            try {
                let url = '/api/catalog/farms';
                const params = new URLSearchParams();

                if (selectedRegion) {
                    params.append('region_id', selectedRegion);
                }
                if (selectedFarmType) {
                    params.append('farm_type', selectedFarmType);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const farms = await response.json();

                const farmsList = document.getElementById('farms-list');
                farmsList.innerHTML = '';

                if (farms.length === 0) {
                    farmsList.innerHTML = `<p class="text-silver col-span-full text-center py-8">${translations.no_farms_found || 'No farms found for the selected criteria.'}</p>`;
                    return;
                }

                farms.forEach(farm => {
                    const description = userLanguage === 'de' ? (farm.description_de || farm.description_uk) : (farm.description_uk || farm.description_de);
                    const imageUrl = farm.image_path ? `/static/uploads/${farm.image_path}` : null;

                    const farmCard = document.createElement('div');
                    farmCard.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg';
                    farmCard.innerHTML = `
                        <div class="h-48 bg-gray-700 flex items-center justify-center">
                            ${imageUrl ?
                                `<img src="${imageUrl}" alt="${farm.name}" class="w-full h-full object-cover">` :
                                `<div class="text-6xl gold-text font-bold">${farm.name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div class="p-6">
                            <h3 class="text-lg font-semibold mb-2 gold-text">${farm.name}</h3>
                            <p class="text-sm text-silver mb-3">${description || translations.no_description || 'No description available'}</p>
                            <div class="flex items-center justify-between text-sm mb-4">
                                <span class="text-silver">${farm.region_name || farm.location || translations.location_not_specified || 'Location not specified'}</span>
                                <span class="gold-text font-medium">${translations[`type_${farm.farm_type}`] || farm.farm_type || translations.type_not_specified || 'Type not specified'}</span>
                            </div>
                            <button class="enter-shop-btn w-full px-4 py-2 bg-transparent border-2 border-gold text-gold hover:bg-gold hover:text-black font-medium rounded-lg transition-colors" data-farm-id="${farm.id}" data-farm-name="${farm.name}" data-farm-description="${description}" data-farm-image="${imageUrl || ''}">
                                üõí ${translations.webapp_enter_shop || 'Enter Shop'}
                            </button>
                        </div>
                    `;
                    farmsList.appendChild(farmCard);
                });
            } catch (error) {
                console.error('Error loading farms:', error);
            }
        }

        function showProducts(farmId, farmName, farmDescription, farmImage) {
            currentView = 'products';
            selectedFarm = { id: farmId, name: farmName, description: farmDescription, image: farmImage };
            selectedCategory = null; // Reset category filter

            // Hide discovery view, show shop view
            document.getElementById('discovery-view').classList.add('hidden');
            document.getElementById('shop-view').classList.remove('hidden');

            // Update farm hero image
            const farmHero = document.getElementById('farm-hero');
            if (farmImage) {
                farmHero.innerHTML = `<img src="${farmImage}" alt="${farmName}" class="w-full h-full object-cover">`;
            } else {
                farmHero.innerHTML = `<div class="text-4xl gold-text font-bold">${farmName.charAt(0).toUpperCase()}</div>`;
            }

            // Update title and description
            document.getElementById('farm-name-title').textContent = farmName;
            document.getElementById('farm-description').textContent = farmDescription || '';

            // Load categories and products
            loadCategories(farmId);
            loadProducts(farmId);
        }

        function showFarms() {
            currentView = 'farms';
            selectedFarm = null;

            // Hide shop view, show discovery view
            document.getElementById('shop-view').classList.add('hidden');
            document.getElementById('discovery-view').classList.remove('hidden');
        }

        function showCartView() {
            // Hide other views, show cart view
            document.getElementById('discovery-view').classList.add('hidden');
            document.getElementById('shop-view').classList.add('hidden');
            document.getElementById('cart-view').classList.remove('hidden');

            // Load translations for cart view
            loadTranslations();
        }

        async function loadProducts(farmId) {
            try {
                let url = `/api/catalog/products?farm_id=${farmId}`;
                if (selectedCategory) {
                    url += `&category_id=${selectedCategory}`;
                }

                const response = await fetch(url);
                const products = await response.json();

                const productsList = document.getElementById('products-list');
                productsList.innerHTML = '';

                if (products.length === 0) {
                    productsList.innerHTML = `<p class="text-silver text-center py-8">${translations.no_products_found || 'No products found for this farm.'}</p>`;
                    return;
                }

                products.forEach(product => {
                    const name = userLanguage === 'de' ? (product.name_de || product.name) : product.name;
                    const description = userLanguage === 'de' ? (product.description_de || product.description) : product.description;
                    const imageUrl = product.image_path ? `/static/uploads/${product.image_path}` : null;

                    const productCard = document.createElement('div');
                    productCard.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg';
                    productCard.innerHTML = `
                        <div class="w-full aspect-square bg-gray-700 flex items-center justify-center">
                            ${imageUrl ?
                                `<img src="${imageUrl}" alt="${name}" class="w-full h-full object-cover">` :
                                `<div class="text-6xl gold-text font-bold">${name.charAt(0).toUpperCase()}</div>`
                            }
                        </div>
                        <div class="p-4">
                            <h3 class="text-lg font-semibold mb-1 gold-text">${name}</h3>
                            <p class="text-sm text-silver mb-2">${description || ''}</p>
                            <div class="flex items-center justify-between">
                                <span class="gold-text font-bold">${product.price ? `${product.price.toFixed(2)} ‚Ç¨` : ''}</span>
                                <div class="flex items-center space-x-2">
                                    <button class="qty-btn px-2 py-1 bg-gray-700 hover:bg-gray-600 text-silver rounded" data-product-id="${product.id}" data-action="decrease">-</button>
                                    <span class="qty-display px-3 py-1 bg-gray-700 text-silver rounded" data-product-id="${product.id}">0</span>
                                    <button class="qty-btn px-2 py-1 bg-gray-700 hover:bg-gray-600 text-silver rounded" data-product-id="${product.id}" data-action="increase">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                    productsList.appendChild(productCard);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadCategories(farmId) {
            try {
                const response = await fetch(`/api/catalog/categories?farm_id=${farmId}`);
                const apiCategories = await response.json();

                // Build categories array with "All" first
                categories = [
                    {
                        id: 'all',
                        name: translations.webapp_all_items || 'All',
                        name_de: translations.webapp_all_items || 'All',
                        image_path: null,
                        description: translations.webapp_all_description || 'All products from this farm',
                        description_de: translations.webapp_all_description || 'Alle Produkte von diesem Hof'
                    },
                    ...apiCategories
                ];

                currentCategoryIndex = 0;
                renderCategorySlider();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderCategorySlider() {
            if (categories.length === 0) return;

            const category = categories[currentCategoryIndex];
            const displayName = userLanguage === 'de' ? category.name_de : category.name;
            const displayDescription = userLanguage === 'de' ? category.description_de : category.description;
            const imageUrl = category.image_path ? `/static/uploads/${category.image_path}` : null;

            const categoryDisplay = document.getElementById('category-display');
            categoryDisplay.innerHTML = `
                <div class="w-full max-w-2xl mx-auto">
                    <div class="aspect-video bg-gray-800 rounded-lg overflow-hidden shadow-lg mb-4">
                        ${imageUrl ?
                            `<img src="${imageUrl}" alt="${displayName}" class="w-full h-full object-cover">` :
                            `<div class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
                                <div class="text-6xl">${category.id === 'all' ? 'üì¶' : getCategoryEmoji(displayName)}</div>
                            </div>`
                        }
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent flex items-end justify-center pb-4">
                            <div class="text-center">
                                <h3 class="text-2xl font-bold gold-text mb-1">${displayName}</h3>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-silver text-sm">${displayDescription || ''}</p>
                </div>
            `;
        }

        function getCategoryEmoji(categoryName) {
            const emojiMap = {
                'Schwein': 'üê∑',
                'Rind': 'üêÆ',
                'Wurst': 'üå≠',
                'Mix': 'ü•©'
            };
            return emojiMap[categoryName] || 'üì¶';
        }

        function updateQuantity(productId, action) {
            const qtyDisplay = document.querySelector(`.qty-display[data-product-id="${productId}"]`);
            let currentQty = parseInt(qtyDisplay.textContent);

            if (action === 'increase') {
                currentQty++;
            } else if (action === 'decrease' && currentQty > 0) {
                currentQty--;
            }

            qtyDisplay.textContent = currentQty;
        }
    </script>
</body>
</html>
</file>

<file path="bot/handlers/start.py">
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery, ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder

from sqlalchemy import select

from core.database import async_session
from core.models import User, StaticPage, Translation
from bot.keyboards.main_menu import get_main_menu_keyboard
from bot.utils import TranslationFilter, get_translation

router = Router()

# FSM States for onboarding
class OnboardingStates(StatesGroup):
    waiting_for_language = State()
    waiting_for_agreement = State()
    waiting_for_name_confirmation = State()
    waiting_for_name_input = State()
    waiting_for_phone = State()

@router.message(Command("start"))
async def start_handler(message: Message, state: FSMContext):
    tg_id = message.from_user.id
    full_name = message.from_user.full_name

    try:
        async with async_session() as session:
            user = await session.scalar(select(User).where(User.tg_id == tg_id))

            # If user exists and has completed onboarding (has phone), show main menu
            if user and user.phone:
                # IMMEDIATELY use the database language preference
                current_lang = user.language_pref.value if user.language_pref else "uk"
                main_menu = await get_main_menu_keyboard(current_lang)
                welcome_text = await get_translation("welcome_message", current_lang)
                choose_hint = await get_translation("choose_section_hint", current_lang)
                await message.answer(f"{welcome_text} {choose_hint}", reply_markup=main_menu)
                return

            # Start onboarding flow for new users or incomplete profiles
            await state.update_data(tg_id=tg_id, full_name=full_name)

            # Language selection
            builder = InlineKeyboardBuilder()
            builder.button(text="üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞", callback_data="lang_uk")
            builder.button(text="üá©üá™ Deutsch", callback_data="lang_de")

            await message.answer(
                "üåç <b>–í–∏–±–µ—Ä—ñ—Ç—å –º–æ–≤—É / Choose language:</b>\n\n"
                "üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞\n"
                "üá©üá™ Deutsch",
                reply_markup=builder.as_markup(),
                parse_mode="HTML"
            )
            await state.set_state(OnboardingStates.waiting_for_language)

    except Exception as e:
        await message.answer("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

# Language selection callback
@router.callback_query(OnboardingStates.waiting_for_language, F.data.startswith("lang_"))
async def process_language(callback: CallbackQuery, state: FSMContext):
    language = callback.data.split("_")[1]  # "uk" or "de"
    await state.update_data(language_pref=language)

    # Save language preference immediately to database
    data = await state.get_data()
    try:
        async with async_session() as session:
            # Get or create user
            user = await session.scalar(select(User).where(User.tg_id == data["tg_id"]))

            if not user:
                user = User(
                    tg_id=data["tg_id"],
                    full_name=data["full_name"]
                )
                session.add(user)

            # Save language preference immediately
            user.language_pref = language
            await session.commit()
    except Exception as e:
        # Continue with onboarding even if DB save fails
        pass

    # Show legal agreement
    if language == "uk":
        text = (
            "üìã <b>–ü—Ä–∞–≤–∏–ª–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏</b>\n\n"
            "–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ Osnabr√ºck Farm Connect!\n\n"
            "–¶—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ø–æ–º–∞–≥–∞—î –º—ñ—Å—Ü–µ–≤–∏–º —Ñ–µ—Ä–º–µ—Ä–∞–º –∑ –û—Å–Ω–∞–±—Ä—é–∫–∞ "
            "–ø—Ä–æ–¥–∞–≤–∞—Ç–∏ —Å–≤—ñ–∂—ñ –ø—Ä–æ–¥—É–∫—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ–π –≥—Ä–æ–º–∞–¥—ñ.\n\n"
            "üîí <b>–ü–æ–ª—ñ—Ç–∏–∫–∞ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ:</b>\n"
            "–í–∞—à—ñ –¥–∞–Ω—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω—å.\n\n"
            "üìû <b>–ö–æ–Ω—Ç–∞–∫—Ç–∏:</b>\n"
            "–î–ª—è –ø–∏—Ç–∞–Ω—å –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n"
            "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –ø–æ–≥–æ–¥–∏—Ç–∏—Å—è –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏."
        )
        agree_text = "‚úÖ –ó–≥–æ–¥–µ–Ω –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏"
    else:
        text = (
            "üìã <b>Nutzungsbedingungen</b>\n\n"
            "Willkommen bei Osnabr√ºck Farm Connect!\n\n"
            "Dieses System hilft lokalen Bauern aus Osnabr√ºck, "
            "frische Produkte an die ukrainische Gemeinschaft zu verkaufen.\n\n"
            "üîí <b>Datenschutz:</b>\n"
            "Ihre Daten werden nur zur Auftragsabwicklung verwendet.\n\n"
            "üìû <b>Kontakte:</b>\n"
            "Bei Fragen wenden Sie sich an den Administrator.\n\n"
            "Dr√ºcken Sie die Schaltfl√§che unten, um den Bedingungen zuzustimmen."
        )
        agree_text = "‚úÖ Ich stimme den Bedingungen zu"

    builder = InlineKeyboardBuilder()
    builder.button(text=agree_text, callback_data="agree")

    await callback.message.edit_text(
        text,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    await state.set_state(OnboardingStates.waiting_for_agreement)
    await callback.answer()

# Agreement callback
@router.callback_query(OnboardingStates.waiting_for_agreement, F.data == "agree")
async def process_agreement(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    language = data.get("language_pref", "uk")
    telegram_name = data.get("full_name", "User")

    # Show success message and suggest Telegram name
    if language == "uk":
        text = (
            "‚úÖ <b>–î—è–∫—É—î–º–æ –∑–∞ –∑–≥–æ–¥—É!</b>\n\n"
            f"üë§ –ú–∏ –±–∞—á–∏–º–æ –≤–∞—Å —è–∫: <b>{telegram_name}</b>\n\n"
            "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ —ñ–º'—è –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω—å?"
        )
        yes_text = "‚úÖ –¢–∞–∫, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ —ñ–º'—è"
        change_text = "‚úèÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —ñ–º'—è"
    else:
        text = (
            "‚úÖ <b>Vielen Dank f√ºr Ihre Zustimmung!</b>\n\n"
            f"üë§ Wir sehen Sie als: <b>{telegram_name}</b>\n\n"
            "Dieses Namen f√ºr Bestellungen verwenden?"
        )
        yes_text = "‚úÖ Ja, diesen Namen verwenden"
        change_text = "‚úèÔ∏è Namen √§ndern"

    builder = InlineKeyboardBuilder()
    builder.button(text=yes_text, callback_data="name_yes")
    builder.button(text=change_text, callback_data="name_change")

    await callback.message.edit_text(
        text,
        reply_markup=builder.as_markup(),
        parse_mode="HTML"
    )
    await state.set_state(OnboardingStates.waiting_for_name_confirmation)
    await callback.answer()

# Name confirmation handlers
@router.callback_query(OnboardingStates.waiting_for_name_confirmation, F.data == "name_yes")
async def process_name_yes(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    telegram_name = data.get("full_name", "User")

    # Use Telegram name
    await state.update_data(real_name=telegram_name)
    await proceed_to_phone(callback.message, state)
    await callback.answer()

@router.callback_query(OnboardingStates.waiting_for_name_confirmation, F.data == "name_change")
async def process_name_change(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    language = data.get("language_pref", "uk")

    if language == "uk":
        text = "üë§ <b>–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —Å–ø—Ä–∞–≤–∂–Ω—î —ñ–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ:</b>\n\n–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ"
    else:
        text = "üë§ <b>Geben Sie Ihren vollst√§ndigen Namen ein:</b>\n\nBeispiel: Ivan Petrenko"

    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(OnboardingStates.waiting_for_name_input)
    await callback.answer()

# Name input handler
@router.message(OnboardingStates.waiting_for_name_input)
async def process_name(message: Message, state: FSMContext):
    name = message.text.strip()

    if len(name) < 2:
        data = await state.get_data()
        language = data.get("language_pref", "uk")

        if language == "uk":
            await message.answer("‚ùå –Ü–º'—è –ø–æ–≤–∏–Ω–Ω–æ –º—ñ—Å—Ç–∏—Ç–∏ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ 2 —Å–∏–º–≤–æ–ª–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:")
        else:
            await message.answer("‚ùå Der Name muss mindestens 2 Zeichen enthalten. Versuchen Sie es erneut:")
        return

    await state.update_data(real_name=name)
    await proceed_to_phone(message, state)

# Phone input handler (both contact and text)
@router.message(OnboardingStates.waiting_for_phone, F.contact)
async def process_phone_contact(message: Message, state: FSMContext):
    phone = message.contact.phone_number
    await finalize_onboarding(message, state, phone)

@router.message(OnboardingStates.waiting_for_phone)
async def process_phone_text(message: Message, state: FSMContext):
    phone = message.text.strip()

    # Basic phone validation
    if not phone or len(phone) < 7:
        data = await state.get_data()
        language = data.get("language_pref", "uk")

        if language == "uk":
            await message.answer("‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É:")
        else:
            await message.answer("‚ùå Bitte geben Sie eine g√ºltige Telefonnummer ein:")
        return

    await finalize_onboarding(message, state, phone)

async def proceed_to_phone(message: Message, state: FSMContext):
    # Request phone number
    data = await state.get_data()
    language = data.get("language_pref", "uk")

    if language == "uk":
        text = "üì± <b>–ù–∞–¥—ñ—à–ª—ñ—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É:</b>\n\n–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É."
        button_text = "üì± –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É"
    else:
        text = "üì± <b>Senden Sie Ihre Telefonnummer:</b>\n\nDr√ºcken Sie die Schaltfl√§che unten oder geben Sie die Nummer manuell ein."
        button_text = "üì± Telefonnummer senden"

    keyboard = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text=button_text, request_contact=True)]],
        resize_keyboard=True,
        one_time_keyboard=True
    )

    await message.answer(text, reply_markup=keyboard, parse_mode="HTML")
    await state.set_state(OnboardingStates.waiting_for_phone)

async def finalize_onboarding(message: Message, state: FSMContext, phone: str):
    data = await state.get_data()

    try:
        async with async_session() as session:
            # Get or create user
            user = await session.scalar(select(User).where(User.tg_id == data["tg_id"]))

            if not user:
                user = User(
                    tg_id=data["tg_id"],
                    full_name=data["full_name"]
                )
                session.add(user)

            # Update user data
            user.language_pref = data["language_pref"]
            user.full_name = data["real_name"]  # Override with real name
            user.phone = phone

            await session.commit()

        # Clear state
        await state.clear()

        # Show success message and main menu
        language = data.get("language_pref", "uk")
        main_menu = await get_main_menu_keyboard(language)
        welcome_text = await get_translation("welcome_message", language)

        if language == "uk":
            success_text = (
                "üéâ <b>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
                "‚úÖ –í–∞—à—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ. –¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ —Ç–∞ —Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.\n\n"
                "üë§ –í–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —Å–≤–æ—ó –¥–∞–Ω—ñ –≤ —Ä–æ–∑–¥—ñ–ª—ñ <b>–ü—Ä–æ—Ñ—ñ–ª—å</b>."
            )
        else:
            success_text = (
                "üéâ <b>Registrierung abgeschlossen!</b>\n\n"
                "‚úÖ Ihre Daten wurden gespeichert. Sie k√∂nnen jetzt den Produktkatalog durchsuchen und Bestellungen aufgeben.\n\n"
                "üë§ Sie k√∂nnen Ihre Daten im Bereich <b>Profil</b> √§ndern."
            )

        await message.answer(success_text, reply_markup=main_menu, parse_mode="HTML")

    except Exception as e:
        await message.answer("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

# Impressum handler
@router.message(TranslationFilter("impressum_button"))
async def handle_impressum_message(message: Message):
    """Handle impressum button clicks in both languages."""
    await impressum_handler(message)

async def impressum_handler(message: Message):
    try:
        async with async_session() as session:
            # Get impressum from StaticPage table
            impressum_page = await session.scalar(
                select(StaticPage).where(StaticPage.slug == "impressum")
            )

            if impressum_page:
                # Get user language preference
                user = await session.scalar(select(User).where(User.tg_id == message.from_user.id))
                language = user.language_pref if user else "uk"

                if language == "uk":
                    title = impressum_page.title_uk or impressum_page.title
                    content = impressum_page.content_uk or impressum_page.content
                else:
                    title = impressum_page.title_de or impressum_page.title
                    content = impressum_page.content_de or impressum_page.content

                text = f"<b>{title}</b>\n\n{content}"
            else:
                text = "‚ÑπÔ∏è <b>Impressum</b>\n\n–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–º–ø–∞–Ω—ñ—é –±—É–¥–µ –¥–æ–¥–∞–Ω–∞ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º."

            await message.answer(text, parse_mode="HTML")

    except Exception as e:
        await message.answer("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.")

# Profile handler
@router.message(TranslationFilter("profile_button"))
async def handle_profile_message(message: Message):
    """Handle profile button clicks in both languages."""
    await profile_handler(message)

async def profile_handler(message: Message, user_id: int = None):
    """Show user profile with balance, name, phone and language toggle."""
    try:
        async with async_session() as session:
            # Use provided user_id or fallback to message sender
            target_user_id = user_id or message.from_user.id
            user = await session.scalar(select(User).where(User.tg_id == target_user_id))

            if not user:
                await message.answer("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
                return

            # Get localized labels
            user_language = user.language_pref.value if user.language_pref else "uk"

            name_label = await get_translation("name_label", user_language)
            phone_label = await get_translation("phone_label", user_language)
            balance_label = await get_translation("balance_label", user_language)
            change_lang_btn = await get_translation("change_lang_btn", user_language)

            # Format profile message
            profile_text = f"üë§ <b>{await get_translation('profile_title', user_language)}</b>\n\n"
            profile_text += f"{name_label}: {user.full_name or '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}\n"
            profile_text += f"{phone_label}: {user.phone or '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}\n"
            profile_text += f"{balance_label}: {user.balance:.2f} ‚Ç¨\n"

            # Create inline keyboard with language toggle
            builder = InlineKeyboardBuilder()
            builder.button(text=change_lang_btn, callback_data="toggle_language")

            await message.answer(
                profile_text,
                reply_markup=builder.as_markup(),
                parse_mode="HTML"
            )

    except Exception as e:
        await message.answer("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—é.")

# Language toggle callback
@router.callback_query(F.data == "toggle_language")
async def toggle_language(callback: CallbackQuery):
    """Toggle user's language preference between UK and DE."""
    try:
        async with async_session() as session:
            # Re-fetch user from DB to get ABSOLUTE current state
            user = await session.scalar(select(User).where(User.tg_id == callback.from_user.id))

            if not user:
                await callback.answer("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
                return

            # Toggle language based on current DB state
            current_lang = user.language_pref.value if user.language_pref else "uk"
            new_language = "de" if current_lang == "uk" else "uk"
            user.language_pref = new_language

            await session.commit()

            # Get confirmation message in new language
            if new_language == "de":
                confirm_msg = "Sprache zu Deutsch gewechselt! üá©üá™"
            else:
                confirm_msg = "–ú–æ–≤—É –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É! üá∫üá¶"

            await callback.answer(confirm_msg, show_alert=True)

            # Update the existing profile message with new language
            await profile_handler(callback.message, user_id=callback.from_user.id)

            # Send updated main menu in new language (single message, no duplicates)
            main_menu = await get_main_menu_keyboard(new_language)
            choose_hint = await get_translation("choose_section_hint", new_language)
            await callback.message.answer(choose_hint, reply_markup=main_menu)

    except Exception as e:
        await callback.answer("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –º–æ–≤–∏.")
</file>

</files>
